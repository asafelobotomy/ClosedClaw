# Security Hardening Progress - February 10, 2026

## Priority 4: Skill/Plugin Signing & Verification - âœ… 80% Complete

### âœ… Completed Today

#### 1. Cryptographic Infrastructure (Pre-existing)
- **Ed25519 signing/verification** (`src/security/skill-signing.ts`)
  - Key pair generation
  - Skill signing with metadata
  - Signature verification
  - PEM-like `.sig` file format
  - 30+ unit tests passing
  
- **Trusted keyring management** (`src/security/trusted-keyring.ts`)
  - JSON keyring at `~/.closedclaw/trusted-keys.json`
  - Trust levels: full, marginal, none
  - Verification methods: manual, web-of-trust, certificate, self
  - CRUD operations with tests

#### 2. CLI Commands (Created Today)
- **`closedclaw skill keygen`** (`src/commands/skill-sign.ts`)
  - Generate Ed25519 key pair
  - Optional auto-add to keyring
  - Secure file permissions (0o600 for private, 0o644 for public)
  - Output: `signing-key-{keyId}.pem` and `.pub`

- **`closedclaw skill sign <skillPath>`** (`src/commands/skill-sign.ts`)
  - Sign skill files with private key
  - Support key directory auto-detection
  - Optional ephemeral key generation
  - Creates `.skill.md.sig` file
  - JSON output mode

- **`closedclaw keys list`** (`src/commands/keys-management.ts`)
  - Display all trusted keys
  - Filter by trust level
  - Show metadata (name, added date, verification method)
  - JSON output mode

- **`closedclaw keys add <keyId> <publicKeyPath>`** (`src/commands/keys-management.ts`)
  - Add public key to keyring
  - Set trust level (full/marginal/none)
  - Specify verification method
  - Optional notes

- **`closedclaw keys remove <keyId>`** (`src/commands/keys-management.ts`)
 - Remove key from keyring

- **`closedclaw keys trust <keyId> --trust <level>`** (`src/commands/keys-management.ts`)
  - Change trust level of existing key

#### 3. Configuration Schema (Added Today)
- **New type: `SkillsSecurityConfig`** (`src/config/types.skills.ts`)
  ```typescript
  skills: {
    security: {
      requireSignature?: boolean;        // Enforce signature verification
      promptOnUnsigned?: boolean;        // Prompt before unsigned install
      minTrustLevel?: "full" | "marginal"; // Minimum trust level
    }
  }
  ```

- **Zod validation** (`src/config/zod-schema.ts`)
  - Schema validation for `skills.security` config
  - Type-safe configuration

#### 4. Integration Points (Updated Today)
- **Security CLI registration** (`src/cli/security-cli.ts`)
  - New `security skill` subcommand group
  - New `security keys` subcommand group
  - Help text and examples
  - Commander.js integration

### ðŸš§ Remaining Work (20%)

#### Skill Installation Verification
- [ ] **Download signature files alongside skills**
  - Modify skill download logic to fetch `.md.sig`
  - Handle missing signature files gracefully

- [ ] **Verify signatures during install**
  - Check `skills.security.requireSignature` config
  - Load public key from keyring by keyId
  - Verify signature matches content
  - Reject if:
    - Signature missing and `requireSignature=true`
    - Signature invalid
    - Key not in keyring
    - Trust level insufficient

- [ ] **User prompts for unsigned skills**
  - When `requireSignature=false` and `promptOnUnsigned=true`
  - Display warning with security implications
  - Ask for confirmation before proceeding

- [ ] **Integration points**
  - `src/agents/skills-install.ts` - `installSkill()` function
  - `src/gateway/server-methods/skills.ts` - `skills.install` RPC method
  - `ui/src/ui/controllers/skills.ts` - UI install handler

#### Testing
- [ ] **Unit tests for CLI commands**
  - `src/commands/skill-sign.test.ts`
  - `src/commands/keys-management.test.ts`

- [ ] **Integration tests**
  - End-to-end: keygen â†’ sign â†’ add key â†’ verify
  - Signed skill installation success
  - Unsigned skill installation blocking (when requireSignature=true)
  - Unsigned skill prompting (when promptOnUnsigned=true)
  - Invalid signature rejection
  - Insufficient trust level rejection

- [ ] **Config validation tests**
  - Schema validation for `skills.security`
  - Default values
  - Invalid configurations

---

## File Inventory

### New Files Created
1. `src/commands/skill-sign.ts` (212 lines)
   - `generateKeyCommand()` - Generate signing key pair
   - `signSkillCommand()` - Sign skill files

2. `src/commands/keys-management.ts` (207 lines)
   - `listKeysCommand()` - List trusted keys
   - `addKeyCommand()` - Add key to keyring
   - `removeKeyCommand()` - Remove key from keyring
   - `trustKeyCommand()` - Change trust level

### Modified Files
1. `src/cli/security-cli.ts`
   - Added `security skill` subcommands
   - Added `security keys` subcommands
   - Imports and CLI registration

2. `src/config/types.skills.ts`
   - Added `SkillsSecurityConfig` type
   - Updated `SkillsConfig` with `security` field

3. `src/config/zod-schema.ts`
   - Added `skills.security` schema validation

4. `TODO.md`
   - Updated Priority 4 progress

---

## Usage Examples

### Generate a Signing Key
```bash
# Generate key pair and add to keyring
closedclaw skill keygen --add-to-keyring --signer-name "alice@example.com"

# Output:
# Generated Signing Key Pair
# Key ID: a3f8b9c2d4e5f6a7...
# Private key: ~/.closedclaw/keys/signing-key-a3f8b9c2.pem
# Public key: ~/.closedclaw/keys/signing-key-a3f8b9c2.pub
# âœ“ Added to trusted keyring
```

### Sign a Skill
```bash
# Sign skill with key from default location
closedclaw skill sign ./my-awesome-skill.md --signer-name "alice@example.com"

# Output:
# Skill Signed
# Skill: ./my-awesome-skill.md
# Signature: ./my-awesome-skill.md.sig
# Signer: alice@example.com
# Key ID: a3f8b9c2d4e5f6a7...
# Timestamp: 2026-02-10T15:30:00.000Z
# âœ“ Signature file created
```

### Manage Trusted Keys
```bash
# List all keys
closedclaw keys list

# Add a developer's public key
closedclaw keys add abc123... ./developer-key.pub \
  --name "Bob Developer" \
  --trust full \
  --notes "Core team member"

# Change trust level
closedclaw keys trust abc123... --trust marginal

# Remove a key
closedclaw keys remove abc123...
```

### Configure Signature Requirements
```json5
// ~/.closedclaw/config.json5
{
  skills: {
    security: {
      requireSignature: true,        // Block unsigned skills
      promptOnUnsigned: true,         // Prompt if unsigned
      minTrustLevel: "full"           // Require full trust
    }
  }
}
```

---

## Next Steps (Continue Priority 4)

1. **Implement signature verification in skill installation**
   - Modify `src/agents/skills-install.ts`
   - Add signature checking before installation
   - Honor `skills.security` config

2. **Add user prompts**
   - Unsigned skill warnings
   - Invalid signature errors
   - Trust level insufficient errors

3. **Write comprehensive tests**
   - CLI command tests
   - Integration tests for full workflow
   - Config validation tests

4. **Documentation**
   - Update `docs/security/skill-signing.md`
   - Create user guide for signing workflow
   - Document config options

**Estimated completion time**: 4-6 hours for remaining work.

---

## Priorities 6 & 7 Status

**Priority 6**: Immutable Audit Logging - Not started
**Priority 7**: OS Keychain Integration - Not started

These will begin once Priority 4 is complete.
